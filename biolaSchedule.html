<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Generator</title>
    <style>
        :root {
            font-family: "Helvetica";
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            /* border-radius: 5px; */
            padding: 2px;
            font-weight: bold;
            font-family: "Helvetica";
        }

        .black {
            background-color: black;
            color: white;
        }
        .color1{
            color: white;
            background-color: #ff0001;
        }
        .color2{
            color: white;
            background-color: #ff6d00;
        }
        .color3{
            color: white;
            background-color: #f0c233;
        }
        .color4{
            color: white;
            background-color: #69a94e;
        }
        .color5{
            color: white;
            background-color: #4386f4;
        }
        .color6{
            color: white;
            background-color: #9b01ff;
        }
        .color7{
            color: white;
            background-color: #fe00ff;
        }
        input {
            /* border-radius: 5px; */
            border: none;
            width: 6ch;

        }
        input[type="text"]{
            font-weight: bold;
            font-family: "Helvetica";
        }
        .courseId {
            width: 9ch;
        }
        .courseTitle {
            width: 30ch;
        }
        .room {
            width: 30ch;
        }
        .headers {
            width: 9ch;
        }
        .column {
            float: left;
            width: 50%;
        }

            /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }

    </style>
    <script>
        // let times = ["8:00 AM","8:30","9:00","9:30","10:00","10:30","11:00","11:30","12:00","12:30","1:00","1:30","2:00","2:30","3:00","3:30","4:00","4:30","5:00","5:30","6:00","6:30","7:00","7:30","8:00","8:30","9:00"]
        // let times = ["00:00","00:30","01:00","01:30","02:00","02:30","03:00","03:30","04:00","04:30","05:00","05:30","06:00","06:30","07:00","07:30","08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30","24:00"]
        let militaryTimes = ["07:00","07:30","08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:00","22:30"]
        async function get(url){
            return new Promise( (resolve, reject) => {
                fetch(url)
                .then(response => response.json())
                .then(data => resolve(data));
            })
        }
        async function initializeTable(){

            for(let time of militaryTimes){
                let rowHTML =
                    `<tr id="${time}">
                    <th class="black">${time}</th>
                    <td class="Sunday"></td>
                    <td class="Monday"></td>
                    <td class="Tuesday"></td>
                    <td class="Wednesday"></td>
                    <td class="Thursday"></td>
                    <td class="Friday"></td>
                    <td class="Saturday"></td>
                    </tr>`
                document.getElementById("schedule").innerHTML += rowHTML
            }
        }
        async function clearTable(){

            for(let time of militaryTimes){
                let rowHTML =
                    `<tr id="${time}">
                    <th class="black">${time}</th>
                    <td class="Sunday"></td>
                    <td class="Monday"></td>
                    <td class="Tuesday"></td>
                    <td class="Wednesday"></td>
                    <td class="Thursday"></td>
                    <td class="Friday"></td>
                    <td class="Saturday"></td>
                    </tr>`
                document.getElementById(time).innerHTML = rowHTML
            }
        }
        async function initializeLegend(){
            for(let i = 1; i <= 7; i++){
                let rowHTML =
                `<tr id="course${i}">
                <th class="courseNumber${i} black">${i}</th>
                <th class="CRN color${i}"><input type="text" class="color${i}" id="crn${i}"/></th>
                <th class="courseId color${i}"></th>
                <th class="courseTitle color${i}"></th>
                <th class="room color${i}"></th>
                </tr>`
                document.getElementById("legend").innerHTML += rowHTML
            }
        }
        async function clearLegend(){
            for(let i = 1; i <= 7; i++){
                let rowHTML =
                `<tr id="course${i}">
                <th class="courseNumber${i} black">${i}</th>
                <th class="CRN color${i}"><input type="text" class="color${i}" id="crn${i}"/></th>
                <th class="courseId color${i}"></th>
                <th class="courseTitle color${i}"></th>
                <th class="room color${i}"></th>
                </tr>`
                document.getElementById(`course${i}`).innerHTML = rowHTML
            }
        }

        async function updateLegend(courseData){

            let c = 1
            for(let {CRN, courseTitle, location, courseNumber, subject} of courseData){
                // subject = 'FIX'
                let rowHTML =
                `<tr id="course${c}">
                <th class="courseNumber${c} black">${c}</th>
                <th class="CRN color${c}"><input type="text" class="color${c}" id="crn${c}" value="${CRN}"/></th>
                <th class="courseId color${c}">${subject} ${courseNumber}</th>
                <th class="courseTitle color${c}">${courseTitle}</th>
                <th class="room color${c}">${location.buildingDescription} - ${location.room}</th>
                </tr>`
                document.getElementById(`course${c}`).innerHTML = rowHTML
                c++
            }
        }

        async function updateClasses(courseData){

                let c=1
                for(let course of courseData){
                    let startHours = course.location.beginTime.substring(0, 2)
                    let endHours = course.location.endTime.substring(0, 2)
                    let startMinutes = parseInt(course.location.beginTime.substring(2, 4))
                    let endMinutes = parseInt(course.location.endTime.substring(2, 4))
                    let startTime = ""
                    let endTime = ""

                    if(startMinutes >= 0 && startMinutes < 30){
                        startMinutes = "00"
                    }else if(startMinutes >= 30 && startMinutes < 60){
                        startMinutes = "30"
                    }
                    if(endMinutes >= 0 && endMinutes < 30){
                        endMinutes = "30"
                    }else if(endMinutes >= 30 && endMinutes < 60){
                        endMinutes = "00"
                        endHours = parseInt(endHours) + 1
                        if(endHours < 10){
                                endHours = `0${endHours}`
                            }else{
                                endHours = endHours.toString()
                            }
                    }
                    let times = []
                    console.log({startHours,startMinutes});

                    while(startHours !== endHours || startMinutes !== endMinutes){
                        times.push({ hour: startHours, minute: startMinutes})
                        if(startMinutes === "00"){
                            startMinutes =  "30"
                        }else{
                            startHours = parseInt(startHours)+1
                            if(startHours < 10){
                                startHours = `0${startHours}`
                            }else{
                                startHours = startHours.toString()
                            }
                            startMinutes =  "00"
                        }
                    }

                    for(let day of course.location.dayNames){
                        for(let {hour, minute} of times){
                            let el = document.querySelector(`#\\3${[...hour].join(" ")}\\:${minute} > td.${day}`)
                            el.setAttribute("class", `${day} color${c}`)
                            el.textContent = `${course.subject} ${course.courseNumber}`
                        }
                    }

                    c++
                }
        }

        async function getCourseDataFromCRNS(crns){
            // let crns = ["5093","5206","5287","5384","5539","5505"]
            return new Promise(async(resolve, reject) => {
                let url = "https://mastertemple.github.io/api/biola/courses/2022/spring/CRNs.json"

                let crnList = await get(url)
                let subjects = []
                for(let crn of crns){
                    subjects.push(crnList[crn])
                }
                subjects = [...new Set([...subjects])]
                let courseData = []
                for(let subject of subjects){
                    let res = await get(`https://mastertemple.github.io/api/biola/courses/2022/spring/${subject}.json`)
                    let data = res.filter(({CRN}) => crns.includes(CRN))
                    data.forEach(e => e.subject = subject)
                    courseData = [...courseData, ...data]
                }
                resolve(courseData)
            })

        }

        async function createSchedule() {
            let crns = []
            for(let i = 1; i <=7; i++){
                crns.push(document.getElementById(`crn${i}`).value.toString().match(/\d+/g))
            }
            crns = crns.filter(f => f!==null)
            crns = crns.map(e => e[0])
            if(crns.length === 0){
                alert("Please Enter 1 or more CRN's")
                return
            }
            clearTable()
            clearLegend()
            let courseData = await getCourseDataFromCRNS(crns)
            updateLegend(courseData)
            updateClasses(courseData)
        }

        document.addEventListener("DOMContentLoaded", function(event) {
            initializeTable()
            initializeLegend()
        });

        document.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                createSchedule()
            }
        });


    </script>
</head>
<body>
    <div class="row">
        <div class="column">
            <h1>Biola Spring 2022 Class Schedule</h1>
            <table id="legend">
                <tr id="legendHeader">
                    <th class="black">#</th>
                    <th class="black">CRN</th>
                    <th class="black">Course</th>
                    <th class="black">Title</th>
                    <th class="black">Room</th>
                </tr>
            </table>
            <br>
            <button id="createSchedule" class="black" font-weight="bold" onclick="createSchedule()">Create Schedule</button>

        </div>
        <div class="column">
            <table id="schedule">
                <tr id="scheduleHeader">
                    <th class="black headers">Time</th>
                    <th class="black headers">Sunday</th>
                    <th class="black headers">Monday</th>
                    <th class="black headers">Tuesday</th>
                    <th class="black headers">Wednesday</th>
                    <th class="black headers">Thursday</th>
                    <th class="black headers">Friday</th>
                    <th class="black headers">Saturday</th>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>